#!/bin/bash

AWS="$1"
SV="$2"

for a in `find "$AWS/.cbmc-batch/jobs" -type d`
do
    cd "$a"
    make sv-benchmark SV=$SV
done

# the original harnesses override some functions via CMBC mechanisms,
# leading to duplicate definitions that need to be removed

sed '/^void .memset(/,+8d' -i \
    $SV/c/aws-c-common/memset_using_uint64_harness.i

sed '/^void .memcpy(/,+8d' -i \
    $SV/c/aws-c-common/memcpy_using_uint64_harness.i

sed '/^void .memset(/,+8d' -i \
    $SV/c/aws-c-common/memset_override_0_harness.i

# clang is confused over such identifier
sed 's/__builtin___mem/___mem/g' -i \
    $SV/c/aws-c-common/*.i

# fix typo in qsort stub
sed '1 i int compare(const void *a, const void *b, unsigned long item_size);' -i \
    $SV/c/aws-c-common/./aws_array_list_sort_harness.i

